{% extends "base.html" %}
{% load static %}

{% block title %}Gerenciar Imagens da Galeria: {{ galeria.nome }}{% endblock %}

{% block content %}
<div class="dashboard-main-container"
     data-galeria-id="{{ galeria.pk }}"
     data-galeria-slug="{{ galeria.slug }}"
     data-definir-capa-url-raw="{% url 'repositorio:definir_capa_galeria' galeria_pk=galeria.pk imagem_pk=0 %}">

    <div class="dashboard-header mb-3">
        <h1 class="header-title">Gerenciar Conteúdo</h1>
        <p class="header-subtitle">Galeria: <span class="text-primary font-bold">{{ galeria.nome }}</span></p>
    </div>

    {% if messages %}
        <ul class="messages p-0">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="card p-3">
        <div class="card-header mb-3">
            <h2 class="section-title">Anexar e Remover Imagens</h2>
            <p class="section-description">
                Clique nas imagens para selecioná-las. Imagens com progresso ainda estão sendo processadas no servidor.
            </p>

            <div id="capa-atual-info" class="mt-2 p-2 border rounded bg-light-gray d-flex align-items-center">
                <h4 class="m-0 mr-2 font-weight-bold" style="font-size: 1rem;">Capa Atual:</h4>
                {% if galeria.capa and galeria.capa.arquivo_processado %}
                    <img id="capa-thumb"
                         src="{% url 'private_media_proxy' path=galeria.capa.arquivo_processado.name %}"
                         alt="Capa"
                         class="thumb-capa-indicator mr-2"
                         style="width: 30px; height: 30px; object-fit: cover; border-radius: 3px;">
                    <span id="capa-text" class="text-success font-weight-bold">
                        ID: {{ galeria.capa.pk }} ({{ galeria.capa.nome_arquivo_original|truncatechars:20 }})
                    </span>
                {% else %}
                    <img id="capa-thumb" src="https://placehold.co/30x30/ccc/fff?text=?" class="thumb-capa-indicator mr-2" style="width: 30px; height: 30px; object-fit: cover; border-radius: 3px; display: none;">
                    <span id="capa-text" class="text-secondary">Nenhuma capa definida.</span>
                {% endif %}
                <span id="current-cover-id" data-cover-id="{{ galeria.capa.pk|default:'' }}" style="display: none;"></span>
            </div>
        </div>

        <form method="post" id="image-selection-form">
            {% csrf_token %}

            {% if todas_imagens_repositorio %}
                <div class="image-picker-grid">
                    {% for imagem in todas_imagens_repositorio %}
                        <div class="image-card
                                    {% if imagem.pk in imagens_vinculadas_pks %}is-selected{% endif %}
                                    {% if galeria.capa.pk == imagem.pk %}is-cover{% endif %}
                                    status-{{ imagem.status_processamento|lower }}"
                             id="image-card-{{ imagem.pk }}"
                             data-image-id="{{ imagem.pk }}"
                             data-status="{{ imagem.status_processamento }}">

                            <div class="processing-overlay {% if imagem.status_processamento == 'PROCESSADA' %}hidden{% endif %}" id="overlay-{{ imagem.pk }}">
                                <div class="w-full px-2">
                                    {% if imagem.status_processamento == 'ERRO' %}
                                        <div class="text-center text-danger text-xs font-bold">
                                            <i class="fas fa-exclamation-circle mb-1"></i><br>ERRO
                                        </div>
                                    {% else %}
                                        <div class="flex justify-between text-[8px] uppercase font-bold text-white mb-1">
                                            <span id="label-{{ imagem.pk }}">Processando</span>
                                            <span id="percent-{{ imagem.pk }}">0%</span>
                                        </div>
                                        <div class="w-full bg-black/50 h-1 rounded-full overflow-hidden">
                                            <div id="bar-{{ imagem.pk }}" class="bg-primary-purple h-full transition-all duration-500" style="width: 0%"></div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            {% if imagem.arquivo_processado %}
                                <img src="{% url 'private_media_proxy' path=imagem.arquivo_processado.name %}" class="image-card-thumb" id="img-{{ imagem.pk }}">
                            {% else %}
                                <div class="image-card-thumb placeholder-no-file"><i class="fas fa-image"></i></div>
                            {% endif %}

                            <input type="checkbox" name="imagens" value="{{ imagem.pk }}" id="checkbox_{{ imagem.pk }}" class="hidden" {% if imagem.pk in imagens_vinculadas_pks %}checked{% endif %}>

                            <span class="selection-indicator"><i class="fas fa-check"></i></span>
                            <span class="cover-indicator"><i class="fas fa-star"></i></span>

                            <div class="image-card-actions">
                                <button type="button" class="btn-action js-rotate-btn" data-image-pk="{{ imagem.pk }}" title="Girar 90°">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                {% if imagem.status_processamento == 'PROCESSADA' %}
                                    <button type="button" class="btn-action js-set-cover-btn" data-image-pk="{{ imagem.pk }}" title="Definir Capa">
                                        <i class="fas fa-image"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-warning">Nenhuma imagem disponível.</div>
            {% endif %}

            <div class="text-right card-footer mt-4">
                <a href="{% url 'repositorio:gerenciar_galerias' %}" class="btn btn-back mr-2">Voltar</a>
                <button type="submit" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<div id="custom-modal" class="custom-modal-overlay hidden">
    <div class="custom-modal-content">
        <h3 id="modal-title"></h3>
        <p id="modal-message"></p>
        <button id="modal-close-btn" class="btn btn-sm btn-primary mt-3">OK</button>
    </div>
</div>

<style>
    .image-card { position: relative; cursor: pointer; border: 2px solid transparent; border-radius: 8px; overflow: hidden; }
    .image-card.is-selected { border-color: #6d28d9; }
    .processing-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 5; }
    .image-card-actions { position: absolute; bottom: 5px; right: 5px; display: flex; gap: 4px; z-index: 10; opacity: 0; transition: 0.3s; }
    .image-card:hover .image-card-actions { opacity: 1; }
    .btn-action { background: #6d28d9; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; }
    .btn-action:hover { background: #5b21b6; }
    .hidden { display: none; }
    .bg-primary-purple { background-color: #6d28d9; }
</style>

<script>
(function() {
    'use strict';

    const container = document.querySelector('.dashboard-main-container');
    const galeriaSlug = container.getAttribute('data-galeria-slug');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // WebSocket: Ajustado para o prefixo repositorio-admin
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socketUrl = `${protocol}${window.location.host}/ws/repositorio-admin/galerias/${galeriaSlug}/`;
    const socket = new WebSocket(socketUrl);

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'progresso_imagem') {
            const imgId = data.imagem_id;
            const progress = data.progresso;
            const status = data.status;

            const bar = document.getElementById(`bar-${imgId}`);
            const percent = document.getElementById(`percent-${imgId}`);
            const overlay = document.getElementById(`overlay-${imgId}`);

            if (bar) bar.style.width = progress + '%';
            if (percent) percent.textContent = Math.round(progress) + '%';

            if (status === 'PROCESSADA') {
                setTimeout(() => {
                    if (overlay) overlay.classList.add('hidden');
                    const img = document.getElementById(`img-${imgId}`);
                    if (img) img.src = img.src.split('?')[0] + '?' + new Date().getTime();
                }, 1000);
            } else if (status === 'PROCESSANDO') {
                if (overlay) overlay.classList.remove('hidden');
            }
        }
    };

    function showCustomModal(title, message, type = 'info') {
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        modalTitle.textContent = title;
        modalTitle.className = type === 'error' ? 'text-danger' : 'text-success';
        modalMessage.textContent = message;
        modal.classList.remove('hidden');
        document.getElementById('modal-close-btn').onclick = () => modal.classList.add('hidden');
    }

    const URL_RAW = container.getAttribute('data-definir-capa-url-raw');
    const DEFINIR_CAPA_URL_TEMPLATE = URL_RAW.replace('/0/', '/IMAGEM_PK/');

    // Seleção de Imagem
    document.querySelectorAll('.image-card').forEach(card => {
        card.addEventListener('click', (e) => {
            if (e.target.closest('.image-card-actions')) return;
            const checkbox = card.querySelector('input[name="imagens"]');
            checkbox.checked = !checkbox.checked;
            card.classList.toggle('is-selected', checkbox.checked);
        });
    });

    // Definir Capa
    document.querySelectorAll('.js-set-cover-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const imagemPk = btn.getAttribute('data-image-pk');
            const url = DEFINIR_CAPA_URL_TEMPLATE.replace('IMAGEM_PK', imagemPk);

            btn.disabled = true;
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest'}
                });
                const data = await res.json();
                if (data.sucesso) {
                    showCustomModal('Sucesso', data.message, 'success');
                    document.querySelectorAll('.image-card').forEach(c => c.classList.remove('is-cover'));
                    btn.closest('.image-card').classList.add('is-cover');

                    const card = btn.closest('.image-card');
                    card.querySelector('input[name="imagens"]').checked = true;
                    card.classList.add('is-selected');

                    document.getElementById('capa-thumb').src = data.capa_url;
                    document.getElementById('capa-thumb').style.display = 'block';
                    document.getElementById('capa-text').textContent = `ID: ${imagemPk}`;
                }
            } catch (err) {
                showCustomModal('Erro', 'Falha ao definir capa', 'error');
            } finally {
                btn.disabled = false;
            }
        });
    });

    // Botão Girar: Ajustado para o prefixo repositorio-admin
    document.querySelectorAll('.js-rotate-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const id = btn.dataset.imagePk;
            const url = `/repositorio-admin/imagem/${id}/girar/`;

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest'}
                });
                const data = await res.json();
                if (data.sucesso) {
                    console.log("Rotação iniciada para:", id);
                } else {
                    showCustomModal('Erro', data.erro || 'Falha ao girar', 'error');
                }
            } catch (err) {
                showCustomModal('Erro', 'Conexão falhou', 'error');
            }
        });
    });

})();
</script>
{% endblock %}