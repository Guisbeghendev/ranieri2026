{% extends "base.html" %}
{% load static %}

{% block title %}Upload de Imagens - Repositório{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-12 max-w-4xl">
    <div class="mb-8 border-b border-border-custom pb-6">
        <h1 class="text-3xl font-bold text-roxo1 tracking-tight uppercase">Área do Fotógrafo</h1>
        <p class="text-text-main opacity-60 text-sm font-medium">Upload Direto para S3 & Processamento Assíncrono</p>
    </div>

    <div class="card-ranieri bg-white p-8 rounded-2xl shadow-sm border border-border-custom">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-2 h-8 bg-secondary rounded-full"></div>
            <h2 class="text-text-main font-bold uppercase text-base tracking-wider">Upload de Novas Imagens</h2>
        </div>

        <div class="space-y-6">
            <p class="text-gray-500 text-xs uppercase tracking-widest leading-relaxed">
                As imagens serão enviadas diretamente ao storage e marcadas d'água automaticamente pelo sistema.
            </p>

            <form id="upload-form" class="space-y-8">
                {% csrf_token %}

                <div class="form-group" id="id_arquivos_group">
                    <div class="group relative border-2 border-dashed border-gray-300 rounded-2xl p-12 text-center cursor-pointer hover:border-primary hover:bg-primary/5 transition-all duration-300" id="file-upload-area">
                        <i class="fas fa-cloud-upload-alt text-5xl text-gray-300 group-hover:text-primary mb-4 transition-colors"></i>
                        <p class="text-text-main font-bold uppercase text-sm tracking-widest mb-2" id="file-count-text">
                            Clique ou arraste as fotos aqui
                        </p>
                        <p class="text-gray-400 text-[10px] uppercase font-semibold">Formatos aceitos: PNG, JPG ou JPEG</p>
                    </div>

                    <div class="hidden">
                        {{ form.arquivos }}
                    </div>
                </div>

                <div id="progress-container" class="hidden space-y-6 bg-surface p-6 rounded-xl border border-border-custom shadow-inner">
                    <div class="space-y-2">
                        <div class="flex justify-between items-end">
                            <span class="text-[10px] uppercase font-black text-roxo1">Progresso Total</span>
                            <span id="total-percent" class="text-lg font-bold text-primary leading-none">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
                            <div id="total-bar" class="bg-primary h-full transition-all duration-500 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="space-y-2 bg-white/50 p-3 rounded-lg">
                        <div class="flex justify-between items-center text-[10px] uppercase font-bold">
                            <span id="current-file-name" class="text-gray-500 truncate max-w-[250px]">Aguardando início...</span>
                            <span id="current-percent" class="text-roxo1">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 h-1.5 rounded-full overflow-hidden">
                            <div id="current-bar" class="bg-secondary h-full transition-all duration-100 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center">
                    <button type="button" class="btn-primary px-12 py-4 shadow-lg disabled:opacity-30 disabled:grayscale transition-all" id="submit-button" disabled>
                        <i class="fas fa-sync-alt mr-2"></i> Iniciar Sincronização
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';

    const fileInput = document.querySelector('input[type="file"]');
    const uploadArea = document.getElementById('file-upload-area');
    const fileCountText = document.getElementById('file-count-text');
    const submitButton = document.getElementById('submit-button');

    const progressContainer = document.getElementById('progress-container');
    const totalBar = document.getElementById('total-bar');
    const totalPercent = document.getElementById('total-percent');
    const currentBar = document.getElementById('current-bar');
    const currentPercent = document.getElementById('current-percent');
    const currentFileName = document.getElementById('current-file-name');

    const SIGN_URL = "{% url 'repositorio:assinar_upload' %}";
    const CONFIRM_URL = "{% url 'repositorio:confirmar_upload' %}";
    const REDIRECT_URL = "{% url 'repositorio:gerenciar_galerias' %}";

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    if (!fileInput || !uploadArea || !submitButton) return;

    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect(e) {
        const count = e.target.files.length;
        if (count > 0) {
            fileCountText.innerHTML = `<span class="text-primary">${count}</span> arquivo(s) prontos para upload.`;
            submitButton.disabled = false;
        }
    }

    submitButton.addEventListener('click', async () => {
        const files = fileInput.files;
        const total = files.length;
        if (total === 0) return;

        submitButton.disabled = true;
        uploadArea.style.pointerEvents = 'none';
        uploadArea.style.opacity = '0.5';
        progressContainer.classList.remove('hidden');

        for (let i = 0; i < total; i++) {
            const overallProgress = (i / total) * 100;
            totalBar.style.width = `${overallProgress}%`;
            totalPercent.textContent = `${Math.round(overallProgress)}%`;

            await processFile(files[i], i + 1, total);
        }

        totalBar.style.width = '100%';
        totalPercent.textContent = '100%';

        setTimeout(() => {
            window.location.href = REDIRECT_URL;
        }, 800);
    });

    function uploadToS3(url, formData, onProgress) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', url);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    onProgress(percent);
                }
            };

            xhr.onload = () => (xhr.status >= 200 && xhr.status < 300) ? resolve() : reject(xhr.statusText);
            xhr.onerror = () => reject("Erro de conexão");
            xhr.send(formData);
        });
    }

    async function processFile(file, index, total) {
        try {
            currentFileName.textContent = `Enviando: ${file.name}`;
            currentFileName.classList.remove('text-red-500');
            currentBar.style.width = '0%';
            currentPercent.textContent = '0%';

            const signRes = await fetch(SIGN_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrftoken},
                body: new URLSearchParams({'nome_arquivo': file.name, 'tipo_mime': file.type || 'image/jpeg'})
            });
            const signData = await signRes.json();

            const formData = new FormData();
            Object.entries(signData.campos_assinados).forEach(([key, value]) => {
                formData.append(key, value);
            });
            formData.append('file', file);

            await uploadToS3(signData.url_assinada, formData, (percent) => {
                currentBar.style.width = `${percent}%`;
                currentPercent.textContent = `${Math.round(percent)}%`;
            });

            await fetch(CONFIRM_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrftoken},
                body: new URLSearchParams({
                    'imagem_id': signData.imagem_id,
                    'total_files': total,
                    'current_index': index
                })
            });

        } catch (error) {
            console.error(error);
            currentFileName.textContent = `Erro no arquivo: ${file.name}`;
            currentFileName.classList.add('text-red-500');
        }
    }
})();
</script>
{% endblock %}