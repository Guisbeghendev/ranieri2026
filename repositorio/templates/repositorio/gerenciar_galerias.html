{% extends "base.html" %}
{% load static %}

{% block title %}Gerenciar Galerias - Repositório{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-12 max-w-7xl dashboard-main-container">

    <div class="mb-8 border-b border-border-custom pb-6 flex flex-col md:flex-row md:items-end md:justify-between gap-6">
        <div>
            <h1 class="text-3xl font-bold text-roxo1 tracking-tight uppercase">Área do Fotógrafo</h1>
            <p class="text-text-main opacity-60 text-sm font-medium">Gestão de Mídias e Galerias</p>
        </div>

        <div class="flex items-center gap-3">
            <a href="{% url 'repositorio:upload_imagem' %}" class="btn-primary bg-verde-petroleo hover:bg-verde-petroleo/90 px-6 py-3 flex items-center gap-2 shadow-md group">
                <i class="fas fa-cloud-upload-alt transition-transform group-hover:-translate-y-1"></i>
                <span class="text-xs uppercase font-black tracking-widest">Fazer Upload</span>
            </a>
            <a href="{% url 'repositorio:criar_galeria' %}" class="btn-primary px-6 py-3 flex items-center gap-2 shadow-md group">
                <i class="fas fa-plus transition-transform group-hover:rotate-90"></i>
                <span class="text-xs uppercase font-black tracking-widest">Nova Galeria</span>
            </a>
        </div>
    </div>

    {% if messages %}
        <div class="mb-6 space-y-2">
            {% for message in messages %}
                <div class="p-4 rounded-xl text-sm font-medium border animate-in fade-in slide-in-from-top-4 duration-300
                    {% if message.tags == 'success' %}bg-green-50 text-green-700 border-green-200{% else %}bg-blue-50 text-blue-700 border-blue-200{% endif %}">
                    <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} mr-2"></i>
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="card-ranieri bg-white rounded-2xl border border-border-custom shadow-sm overflow-hidden">
        <div class="p-6 border-b border-border-custom bg-surface/30">
            <h2 class="text-lg font-bold text-roxo1 uppercase tracking-wider flex items-center gap-2">
                <i class="fas fa-layer-group text-primary"></i>
                Lista de Galerias
            </h2>
        </div>

        <div class="overflow-x-auto">
            {% if object_list %}
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-surface text-[10px] uppercase font-black text-gray-400 tracking-[0.2em] border-b border-border-custom">
                            <th class="px-6 py-4 w-24">Capa</th>
                            <th class="px-6 py-4">Título & Descrição</th>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4 text-center">Mídias</th>
                            <th class="px-6 py-4">Cronologia</th>
                            <th class="px-6 py-4 text-center">Gerenciamento</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-border-custom">
                        {% for galeria in object_list %}
                        <tr id="galeria-row-{{ galeria.pk }}" class="hover:bg-primary/5 transition-colors group">
                            <td class="px-6 py-4">
                                {% if galeria.capa_proxy_url %}
                                    <div class="w-16 h-16 rounded-xl overflow-hidden border-2 border-border-custom shadow-sm group-hover:border-primary transition-colors">
                                        <img src="{{ galeria.capa_proxy_url }}" alt="Capa" class="w-full h-full object-cover">
                                    </div>
                                {% else %}
                                    <div class="w-16 h-16 rounded-xl bg-surface border-2 border-dashed border-gray-200 flex items-center justify-center text-gray-300">
                                        <i class="fas fa-image text-xl"></i>
                                    </div>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <h3 class="text-base font-bold text-roxo1 leading-tight mb-1">{{ galeria.nome }}</h3>
                                <p class="text-xs text-gray-400 font-medium line-clamp-1 italic">
                                    {{ galeria.descricao|default:"Sem descrição informada." }}
                                </p>
                            </td>
                            <td class="px-6 py-4 js-status-cell">
                                {% if galeria.status == 'PR' %}<span class="px-3 py-1 rounded-full text-[10px] font-black uppercase bg-amber-100 text-amber-600 border border-amber-200">Rascunho</span>
                                {% elif galeria.status == 'PB' %}<span class="px-3 py-1 rounded-full text-[10px] font-black uppercase bg-green-100 text-green-600 border border-green-200">Publicada</span>
                                {% elif galeria.status == 'AR' %}<span class="px-3 py-1 rounded-full text-[10px] font-black uppercase bg-red-100 text-red-600 border border-red-200">Arquivada</span>
                                {% elif galeria.status == 'PC' or galeria.status == 'RV' %}<span class="px-3 py-1 rounded-full text-[10px] font-black uppercase bg-blue-100 text-blue-600 border border-blue-200 animate-pulse">Processando</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-roxo1/5 text-roxo1 font-bold text-xs border border-roxo1/10">
                                    {{ galeria.imagens_count }}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="space-y-1">
                                    <div class="flex items-center gap-2 text-[10px] font-bold text-gray-400">
                                        <i class="far fa-calendar-plus"></i>
                                        <span>{{ galeria.criado_em|date:"d/m/Y" }}</span>
                                    </div>
                                    {% if galeria.alterado_em %}
                                    <div class="flex items-center gap-2 text-[10px] font-bold text-primary">
                                        <i class="far fa-edit"></i>
                                        <span>{{ galeria.alterado_em|date:"d/m/Y" }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center justify-center gap-2" id="actions-{{ galeria.pk }}">
                                    <a href="{% url 'repositorio:editar_galeria' pk=galeria.pk %}" class="w-9 h-9 flex items-center justify-center rounded-lg bg-surface border border-border-custom text-gray-500 hover:bg-roxo1 hover:text-white hover:border-roxo1 transition-all" title="Editar Galeria">
                                        <i class="fas fa-pencil-alt text-xs"></i>
                                    </a>
                                    <a href="{% url 'repositorio:gerenciar_imagens_galeria' pk=galeria.pk %}" class="w-9 h-9 flex items-center justify-center rounded-lg bg-surface border border-border-custom text-gray-500 hover:bg-secondary hover:text-white hover:border-secondary transition-all" title="Gerenciar Mídias">
                                        <i class="fas fa-photo-video text-xs"></i>
                                    </a>

                                    <div class="js-status-actions flex gap-2" data-pk="{{ galeria.pk }}" data-status="{{ galeria.status }}">
                                        {% if galeria.status != 'PB' %}
                                            <form method="post" action="{% url 'repositorio:publicar_galeria' pk=galeria.pk %}" class="js-action-form" data-action="publicar" data-galeria-pk="{{ galeria.pk }}">
                                                {% csrf_token %}
                                                <button type="submit" class="w-9 h-9 flex items-center justify-center rounded-lg bg-green-50 text-green-600 border border-green-100 hover:bg-green-600 hover:text-white transition-all js-action-button" title="Publicar">
                                                    <i class="fas fa-rocket text-xs"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                        {% if galeria.status == 'PR' or galeria.status == 'PB' %}
                                            <form method="post" action="{% url 'repositorio:arquivar_galeria' pk=galeria.pk %}" class="js-action-form" data-action="arquivar" data-galeria-pk="{{ galeria.pk }}">
                                                {% csrf_token %}
                                                <button type="submit" class="w-9 h-9 flex items-center justify-center rounded-lg bg-amber-50 text-amber-600 border border-amber-100 hover:bg-amber-600 hover:text-white transition-all js-action-button" title="Arquivar">
                                                    <i class="fas fa-archive text-xs"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                    </div>

                                    <button class="w-9 h-9 flex items-center justify-center rounded-lg bg-red-50 text-red-600 border border-red-100 hover:bg-red-600 hover:text-white transition-all"
                                            title="Excluir"
                                            data-galeria-pk="{{ galeria.pk }}"
                                            data-delete-url="{% url 'repositorio:excluir_galeria' pk=galeria.pk %}"
                                            onclick="confirmDelete(this)">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="p-20 text-center">
                    <div class="w-20 h-20 bg-surface rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-dashed border-gray-200">
                        <i class="fas fa-folder-open text-3xl text-gray-200"></i>
                    </div>
                    <h3 class="text-roxo1 font-bold text-lg mb-1">Nenhuma galeria encontrada</h3>
                    <p class="text-gray-400 text-sm mb-6">Comece criando sua primeira galeria de mídias.</p>
                    <a href="{% url 'repositorio:criar_galeria' %}" class="btn-primary inline-flex px-8 py-3 uppercase text-[10px] font-black tracking-widest">
                        Criar Agora
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<form id="delete-form" method="post" class="hidden">{% csrf_token %}</form>

<script>
(function() {
    'use strict';
    const deleteForm = document.getElementById('delete-form');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const statusSocket = new WebSocket(protocol + window.location.host + '/ws/repositorio/galerias/');

    statusSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        updateGalleryRow(data.galeria_id, data.status_code);
    };

    function updateGalleryRow(pk, newStatus) {
        const row = document.getElementById(`galeria-row-${pk}`);
        if (!row) return;

        const statusCell = row.querySelector('.js-status-cell');
        if (statusCell) statusCell.innerHTML = createStatusBadge(newStatus);

        const actionsGroup = row.querySelector('.js-status-actions');
        if (actionsGroup) {
            actionsGroup.setAttribute('data-status', newStatus);
            actionsGroup.innerHTML = '';

            const btnContainer = document.createElement('div');
            btnContainer.className = "flex gap-2";

            if (newStatus !== 'PB') {
                btnContainer.appendChild(createActionForm('publicar', pk, 'bg-green-50 text-green-600 border-green-100 hover:bg-green-600', 'fa-rocket', 'Publicar'));
            }
            if (newStatus === 'PR' || newStatus === 'PB') {
                btnContainer.appendChild(createActionForm('arquivar', pk, 'bg-amber-50 text-amber-600 border-amber-100 hover:bg-amber-600', 'fa-archive', 'Arquivar'));
            }

            actionsGroup.appendChild(btnContainer);
            actionsGroup.querySelectorAll('.js-action-form').forEach(f => f.addEventListener('submit', handleActionSubmit));
        }
    }

    function createStatusBadge(status) {
        const badges = {'PR': 'amber', 'PB': 'green', 'AR': 'red', 'PC': 'blue', 'RV': 'blue'};
        const labels = {'PR': 'Rascunho', 'PB': 'Publicada', 'AR': 'Arquivada', 'PC': 'Processamento', 'RV': 'Processamento'};
        const pulseClass = (status === 'PC' || status === 'RV') ? 'animate-pulse' : '';

        return `<span class="px-3 py-1 rounded-full text-[10px] font-black uppercase bg-${badges[status]}-100 text-${badges[status]}-600 border border-${badges[status]}-200 ${pulseClass}">${labels[status]}</span>`;
    }

    function createActionForm(action, pk, btnColors, iconClass, title) {
        const url = action === 'publicar' ? `{% url 'repositorio:publicar_galeria' pk=0 %}`.replace('0', pk) : `{% url 'repositorio:arquivar_galeria' pk=0 %}`.replace('0', pk);
        const div = document.createElement('div');
        div.innerHTML = `
            <form method="post" action="${url}" class="js-action-form" data-action="${action}" data-galeria-pk="${pk}">
                <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                <button type="submit" class="w-9 h-9 flex items-center justify-center rounded-lg border transition-all hover:text-white ${btnColors} js-action-button" title="${title}">
                    <i class="fas ${iconClass} text-xs"></i>
                </button>
            </form>`.trim();
        return div.firstChild;
    }

    async function handleActionSubmit(e) {
        e.preventDefault();
        const form = e.currentTarget;
        const btn = form.querySelector('.js-action-button');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i>';

        try {
            const res = await fetch(form.action, {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken, 'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams(new FormData(form))
            });
            const data = await res.json();
            if (data.status_mudou) updateGalleryRow(form.getAttribute('data-galeria-pk'), data.status);
            // Poderia usar um toast aqui em vez de alert
        } catch (err) {
            console.error('Erro na ação:', err);
        } finally {
            btn.disabled = false;
        }
    }

    window.confirmDelete = function(btn) {
        if (confirm('Tem certeza que deseja excluir permanentemente esta galeria?')) {
            deleteForm.action = btn.getAttribute('data-delete-url');
            deleteForm.submit();
        }
    }

    document.querySelectorAll('.js-action-form').forEach(f => f.addEventListener('submit', handleActionSubmit));
})();
</script>
{% endblock %}