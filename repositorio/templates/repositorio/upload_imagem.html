{% extends "base.html" %}
{% load static %}

{% block title %}Upload de Imagens - Repositório{% endblock %}

{% block content %}
<div class="dashboard-main-container">
    <div class="dashboard-header mb-3 border-b border-silver/10 pb-4">
        <h1 class="text-2xl font-bold text-primary-purple uppercase tracking-tighter">Área do Fotógrafo</h1>
        <p class="text-silver text-xs">Upload Direto para S3 & Processamento Assíncrono</p>
    </div>

    <div class="card-surface bg-surface p-6 rounded-lg border border-silver/10">
        <h2 class="text-white font-bold uppercase text-sm mb-4">Upload de Novas Imagens</h2>

        <div class="card-body">
            <p class="text-silver text-xs mb-6 uppercase tracking-widest">
                As imagens serão enviadas diretamente ao storage e marcadas d'água automaticamente.
            </p>

            <form id="upload-form" class="space-y-6">
                {% csrf_token %}

                <div class="form-group" id="id_arquivos_group">
                    {# Área de Drop Otimizada (Guisbeghen Style) #}
                    <div class="file-upload-wrapper border-2 border-dashed border-silver/20 rounded-lg p-10 text-center cursor-pointer hover:border-primary-purple transition-all" id="file-upload-area">
                        <i class="fas fa-images text-4xl text-silver/30 mb-4"></i>
                        <p class="text-white font-bold uppercase text-xs tracking-widest" id="file-count-text">
                            Clique ou arraste as fotos aqui
                        </p>
                        <p class="text-silver text-[10px] mt-2 uppercase">PNG, JPG ou JPEG</p>
                    </div>

                    {# Input Oculto #}
                    <div class="hidden">
                        {{ form.arquivos }}
                    </div>
                </div>

                {# Container de Progresso Duplo #}
                <div id="progress-container" class="hidden space-y-4 mt-6 bg-black/20 p-4 rounded border border-silver/5">
                    <div class="space-y-1">
                        <div class="flex justify-between text-[10px] uppercase font-bold">
                            <span class="text-silver">Progresso Total</span>
                            <span id="total-percent" class="text-primary-purple">0%</span>
                        </div>
                        <div class="w-full bg-black h-1 rounded-full overflow-hidden">
                            <div id="total-bar" class="bg-primary-purple h-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <div class="flex justify-between text-[10px] uppercase font-bold">
                            <span id="current-file-name" class="text-silver truncate max-w-[200px]">Aguardando...</span>
                            <span id="current-percent" class="text-white">0%</span>
                        </div>
                        <div class="w-full bg-black/50 h-1 rounded-full overflow-hidden">
                            <div id="current-bar" class="bg-white h-full transition-all duration-100" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mt-6">
                    <button type="button" class="px-8 py-3 bg-primary-purple hover:bg-purple-hover text-white font-bold uppercase text-xs tracking-widest disabled:opacity-50 transition-all" id="submit-button" disabled>
                        Iniciar Sincronização
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';

    const fileInput = document.querySelector('input[type="file"]');
    const uploadArea = document.getElementById('file-upload-area');
    const fileCountText = document.getElementById('file-count-text');
    const submitButton = document.getElementById('submit-button');

    // Elementos de Progresso
    const progressContainer = document.getElementById('progress-container');
    const totalBar = document.getElementById('total-bar');
    const totalPercent = document.getElementById('total-percent');
    const currentBar = document.getElementById('current-bar');
    const currentPercent = document.getElementById('current-percent');
    const currentFileName = document.getElementById('current-file-name');

    const SIGN_URL = "{% url 'repositorio:assinar_upload' %}";
    const CONFIRM_URL = "{% url 'repositorio:confirmar_upload' %}";
    const REDIRECT_URL = "{% url 'repositorio:gerenciar_galerias' %}";

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    if (!fileInput || !uploadArea || !submitButton) return;

    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect(e) {
        const count = e.target.files.length;
        if (count > 0) {
            fileCountText.textContent = `${count} arquivo(s) prontos para upload.`;
            submitButton.disabled = false;
        }
    }

    submitButton.addEventListener('click', async () => {
        const files = fileInput.files;
        const total = files.length;
        if (total === 0) return;

        submitButton.disabled = true;
        uploadArea.style.pointerEvents = 'none';
        progressContainer.classList.remove('hidden');

        for (let i = 0; i < total; i++) {
            // Atualiza barra geral antes de começar o arquivo
            const overallProgress = (i / total) * 100;
            totalBar.style.width = `${overallProgress}%`;
            totalPercent.textContent = `${Math.round(overallProgress)}%`;

            await processFile(files[i], i + 1, total);
        }

        totalBar.style.width = '100%';
        totalPercent.textContent = '100%';

        // Pequeno delay para o usuário ver o 100% antes de redirecionar
        setTimeout(() => {
            window.location.href = REDIRECT_URL;
        }, 500);
    });

    function uploadToS3(url, formData, onProgress) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', url);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    onProgress(percent);
                }
            };

            xhr.onload = () => (xhr.status >= 200 && xhr.status < 300) ? resolve() : reject(xhr.statusText);
            xhr.onerror = () => reject("Erro de conexão");
            xhr.send(formData);
        });
    }

    async function processFile(file, index, total) {
        try {
            currentFileName.textContent = `Enviando: ${file.name}`;
            currentBar.style.width = '0%';
            currentPercent.textContent = '0%';

            // 1. Solicita Assinatura S3
            const signRes = await fetch(SIGN_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrftoken},
                body: new URLSearchParams({'nome_arquivo': file.name, 'tipo_mime': file.type || 'image/jpeg'})
            });
            const signData = await signRes.json();

            // 2. Upload para S3 com monitoramento de progresso
            const formData = new FormData();
            Object.entries(signData.campos_assinados).forEach(([key, value]) => {
                formData.append(key, value);
            });
            formData.append('file', file);

            await uploadToS3(signData.url_assinada, formData, (percent) => {
                currentBar.style.width = `${percent}%`;
                currentPercent.textContent = `${Math.round(percent)}%`;
            });

            // 3. Confirmar e disparar Celery
            await fetch(CONFIRM_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrftoken},
                body: new URLSearchParams({
                    'imagem_id': signData.imagem_id,
                    'total_files': total,
                    'current_index': index
                })
            });

        } catch (error) {
            console.error(error);
            currentFileName.textContent = `Erro: ${file.name}`;
            currentFileName.style.color = '#ff4444';
        }
    }
})();
</script>
{% endblock %}